import{m as e,a as t}from"../../../pinia-CTzb92xA.min.js";import{o as a}from"../../../index-CQ188U4T.min.js";import{g as s,u as n}from"../../../AdyenStore-Cj1di2dy.min.js";import o from"../PaymentCard/PaymentCard.min.js";import{g as i,v as d}from"../../../getAdyenPaymentStatus-BXPlZruE.min.js";import{l as r}from"../../../loadFromCheckout-BMerKOqv.min.js";import{c,f as m,g as y,e as h,T as l,F as u,h as p,w as P,b as g,o as S,n as M,r as f}from"../../../runtime-core.esm-bundler-D9EqWZvo.min.js";var C=async e=>{const[t,a]=await r(["services.graphQlRequest","stores.useCartStore"]),{maskedId:s}=a;return t("\n    mutation getAdyenPaymentDetails($payload: String!, $cartId: String!) {\n      adyenPaymentDetails(payload:  $payload, cart_id: $cartId) {\n        isFinal\n        resultCode\n        additionalData\n        action\n      }\n  }",{cartId:s,payload:e}).then((e=>e.data.adyenPaymentDetails))},_={name:"AdyenPaymentMethods",components:{AdyenPaymentCard:o},props:{id:{type:String,default:"adyen-dropin-container"},storedPayments:{type:Boolean,default:!1}},emits:["adyenPaymentSelected"],data:()=>({agreementLocation:"",storedPaymentCardsLocation:"",orderId:null,storedPaymentMethods:[],storedPaymentSelected:!1,selectedOriginalId:null,paymentMethodTitles:null,methodSelectedClass:"adyen-checkout__payment-method--selected",isErrorDisplayed:!1,hideStoredPaymentRadio:!1,paymentLoading:!1,paymentVisible:!0,isRecaptchaVisible:!1,Agreements:null,PrivacyPolicy:null,Recaptcha:null,selectedMethod:null}),computed:{...e(n,["adyenVaultEnabled","getAdyenClientKey"])},watch:{selectedMethod:{handler(e){null!==e&&void 0!==this.checkout&&(this.id!==e&&this.checkout.dropinRef&&this.checkout.dropinRef.closeActivePaymentMethod(),this.storedPaymentSelected=this.id===e,"adyen-dropin-container-stored"!==e&&(this.storedPaymentMethods=this.storedPaymentMethods.map((e=>{const t=e;return t.default=!1,t}))))},immediate:!0,deep:!0}},async created(){const[e,t,n,o,d,c,m,y,h,l,u]=await r(["components.Agreements","components.PrivacyPolicy","components.Recaptcha","helpers.getPaymentExtensionAttributes","services.createPaymentGraphQl","stores.useAgreementStore","stores.useCartStore","stores.useConfigStore","stores.useCustomerStore","stores.usePaymentStore","stores.useRecaptchaStore"]);await y.getInitialConfig(),await this.getInitialConfigValues(),await m.getCart(),this.Agreements=e,this.PrivacyPolicy=t,this.Recaptcha=n,this.isRecaptchaVisible=u.isRecaptchaVisible("placeOrder"),this.selectedMethod=l.selectedMethod;const p=await this.getPaymentMethodsResponse();if(this.storedPaymentMethods=this.getFilteredStoredMethods(p),this.storedPayments&&!this.storedPaymentMethods.length)return;this.storedPaymentSelected=!0;const P=o(),g={paymentMethodsResponse:p,clientKey:await this.getAdyenClientKey,locale:y.locale,environment:s()?"live":"test",analytics:{enabled:!1},amount:{value:m.cartGrandTotal,currency:y.currencyCode},showPaymentMethods:!this.storedPayments,onAdditionalDetails:this.handleAdditionalDetails.bind(this),onError:this.handleOnError.bind(this),onSubmit:(e,t)=>{const a=c.validateAgreements(),s=u.validateToken("placeOrder");if(e.isValid=a&&s,e.isValid){const a=this.getPaymentMethod(e,P);l.paymentEmitter.emit("adyenPaymentLoading",{id:this.id,loading:!0}),d(a).then(this.setOrderId).then(i).then((e=>this.handlePaymentStatus(e,t))).catch((e=>{throw this.displayError(t,e.message),Error(e)}))}else t.setStatus("ready")},paymentMethodsConfiguration:{card:{hasHolderName:!1,holderNameRequired:!1,enableStoreDetails:h.isLoggedIn&&this.adyenVaultEnabled,hideCVC:!1,name:"Credit or debit card"},threeDS2:{challengeWindowSize:"05"}}},S=await a(g);if(this.checkout=S.create("dropin",{showStoredPaymentMethods:this.storedPayments,showPaymentMethods:!this.storedPayments,openFirstPaymentMethod:!this.storedPaymentMethods.length,openFirstStoredPaymentMethod:this.storedPaymentMethods.length,setStatusAutomatically:!1,onSelect:this.onSelect}),this.checkout.mount(`#${this.id}`),this.storedPayments&&this.storedPaymentMethods.length){const e=document.getElementById("adyen-dropin-container-new"),t={childList:!0,subtree:!0},a=(e,t)=>{e.some((e=>e.target.classList.contains("adyen-checkout__dropin--ready")))&&(this.modifyStoredPayments(),t.disconnect())};new MutationObserver(a).observe(e,t)}l.paymentEmitter.on("adyenPaymentDisplayingError",(({id:e,isDisplaying:t})=>{this.id!==e&&(this.isErrorDisplayed=t),this.hideStoredPaymentRadio=t})),l.paymentEmitter.on("adyenPaymentLoading",(({id:e,loading:t})=>{this.id!==e&&(t?this.checkout.setStatus("loading"):this.checkout.setStatus("ready"),this.paymentLoading=t)})),l.paymentEmitter.on("adyenStoredPaymentCardSelected",(({originalId:e})=>{if(this.storedPaymentMethods=this.storedPaymentMethods.map((t=>{const a=t;return a.default=e===t.originalId,a})),e){document.getElementById(e).click(),this.selectedOriginalId=e}}))},async beforeUnmount(){const[e]=await r(["stores.usePaymentStore"]);this.checkout&&(e.paymentEmitter.all.clear(),this.checkout.unmount(),this.clearPaymentReponseCache())},methods:{...t(n,["getInitialConfigValues","getPaymentMethodsResponse","clearPaymentReponseCache"]),setOrderId(e){return this.orderId=e,e},getFilteredStoredMethods:e=>e.storedPaymentMethods?e.storedPaymentMethods.filter((e=>e.supportedShopperInteractions.includes("Ecommerce"))):[],getPaymentMethod(e){const t={code:"scheme"===e.data.paymentMethod.type?"adyen_cc":`adyen_${e.data.paymentMethod.type}`};e.data?.paymentMethod?.storedPaymentMethodId&&(e.data.storePaymentMethod=!0);const a=JSON.stringify(e.data);return"adyen_cc"===t.code?t.adyen_additional_data_cc={cc_type:e.data.paymentMethod.brand,stateData:a,recurringProcessingModel:"CardOnFile",is_active_payment_token_enabler:!!e.data.storePaymentMethod}:t.adyen_additional_data={brand_code:e.data.paymentMethod.type,stateData:a},t},async handlePaymentStatus(e,t){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,a]=await r(["helpers.getCartSectionNames","services.refreshCustomerData"]);t.setStatus("success"),await a(e()),setTimeout((()=>this.redirectToSuccess()),3e3)}else this.displayError(t,e.message)}else e.action&&("threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened"),t.handleAction(e.action))},async handleAdditionalDetails(e,t){try{t.setStatus("loading"),document.body.classList.remove("gene-checkout-threeds-opened");const a=e.data?e.data:{};a.orderId=this.orderId;const s=await C(JSON.stringify(a));await this.handlePaymentStatus(s,t)}catch(e){const a=e.response?.data?.message;this.displayError(t,a)}},async redirectToSuccess(){const[e]=await r(["helpers.getSuccessPageUrl"]);window.location.href=e()},handleOnError(e,t){if("CANCEL"===e.name){const e={orderId:this.orderId,cancelled:!0};this.handleOnCancel(e,t)}else this.displayError(t)},async handleOnCancel(e,t){try{await C(JSON.stringify(e))}catch(e){this.displayError(t,e.response?.data?.message)}},async displayError(e,t=this.$t("errorMessages.unexpectedPaymentError")){const[a]=await r(["stores.usePaymentStore"]);a.paymentEmitter.emit("adyenPaymentDisplayingError",{id:this.id,isDisplaying:!0}),e.setStatus("error",{message:t}),setTimeout((()=>{e.setStatus("ready"),a.paymentEmitter.emit("adyenPaymentDisplayingError",{id:this.id,isDisplaying:!1}),a.paymentEmitter.emit("adyenPaymentLoading",{id:this.id,loading:!1}),this.storedPayments&&this.storedPaymentMethods.length&&setTimeout((()=>this.modifyStoredPayments()),0),this.updateAgreementLocation()}),3e3)},async onSelect(){const[e]=await r(["stores.usePaymentStore"]);e.selectPaymentMethod(this.id),setTimeout(this.updateAgreementLocation,0)},updateAgreementLocation(){this.agreementLocation="",setTimeout((()=>{this.agreementLocation=`.${this.methodSelectedClass}\n            .adyen-checkout__payment-method__details`}),0)},async modifyStoredPayments(){const[e]=await r(["stores.usePaymentStore"]);setTimeout((()=>{setTimeout((()=>{this.storedPaymentCardsLocation=""}),0);const t=`#${this.id} .adyen-checkout__payment-methods-list`,a=document.querySelector(t),s=this.paymentMethodTitles||a.querySelectorAll(".adyen-checkout__payment-method__header__title");this.createStyledList(a,s.length),this.storedPaymentMethods=this.storedPaymentMethods.map(((e,t)=>{const a=e;return a.originalId=s[t].id,a}));this.storedPaymentMethods.find((({originalId:e})=>e===this.selectedOriginalId))||(this.storedPaymentMethods[0].default=!0,this.selectedOriginalId=this.storedPaymentMethods[0].originalId),this.storedPaymentMethods.forEach((t=>{t.default&&e.paymentEmitter.emit("adyenStoredPaymentCardSelected",{originalId:this.selectedOriginalId})}))}),0)},createStyledList(e,t){const a=document.createElement("div");a.classList.add("adyen-checkout__payment-methods-list-styled"),a.classList.add(`adyen-checkout__payment-methods-list-styled-${t}`),e.before(a),setTimeout((()=>{this.storedPaymentCardsLocation=".adyen-checkout__payment-methods-list-styled"}),0)}}};const E=["id","data-cy"];_.render=function(e,t,a,s,n,o){const i=f("AdyenPaymentCard");return!a.storedPayments||n.storedPaymentMethods.length?(S(),c(u,{key:0},[""!==n.agreementLocation?(S(),m(l,{key:0,to:n.agreementLocation},[(S(),m(y(n.Agreements),{id:"adyenDropIn-"+(a.storedPayments?"stored":"new")},null,8,["id"])),(S(),m(y(n.PrivacyPolicy))),n.isRecaptchaVisible?(S(),m(y(n.Recaptcha),{key:0,id:"placeOrder",location:"adyenDropIn"+(a.storedPayments?"stored":"new")},null,8,["location"])):h("v-if",!0)],8,["to"])):h("v-if",!0),a.storedPayments&&""!==n.storedPaymentCardsLocation?(S(),m(l,{key:1,to:n.storedPaymentCardsLocation},[(S(!0),c(u,null,p(n.storedPaymentMethods,(e=>P((S(),m(i,{class:M({"adyen-stored-payment-selected":n.storedPaymentSelected}),key:e.id,method:e},null,8,["class","method"])),[[d,!n.isErrorDisplayed&&n.paymentVisible]]))),128))],8,["to"])):h("v-if",!0),P(g("div",{id:a.id,"data-cy":a.id},null,8,E),[[d,!n.isErrorDisplayed&&n.paymentVisible]])],64)):h("v-if",!0)},_.__file="src/components/DropIn/PaymentMethods/PaymentMethods.vue";export{_ as default};
