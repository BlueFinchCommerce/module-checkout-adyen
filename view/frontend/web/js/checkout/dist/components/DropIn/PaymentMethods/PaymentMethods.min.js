import{m as e,g as t,a as s,u as a}from"../../../AdyenStore-CJsb1-8O.min.js";import{o as n}from"../../../index-CQ188U4T.min.js";import o from"../PaymentCard/PaymentCard.min.js";import{g as i}from"../../../getAdyenPaymentStatus-N9BMjOD5.min.js";import{g as d}from"../../../getAdyenPaymentDetails-D8STZY6K.min.js";import{l as r,g as c,c as m,a as h,r as y,e as l,T as u,F as p,f as P,w as g,b as S,o as M,n as f}from"../../../loadFromCheckout-BNS9Ap-h.min.js";import{v as _}from"../../../runtime-dom.esm-bundler-D5EIMfl5.min.js";var C={name:"AdyenPaymentMethods",components:{AdyenPaymentCard:o},props:{id:{type:String,default:"adyen-dropin-container"},storedPayments:{type:Boolean,default:!1}},emits:["adyenPaymentSelected"],data:()=>({agreementLocation:"",storedPaymentCardsLocation:"",orderId:null,storedPaymentMethods:[],storedPaymentSelected:!1,selectedOriginalId:null,paymentMethodTitles:null,methodSelectedClass:"adyen-checkout__payment-method--selected",isErrorDisplayed:!1,hideStoredPaymentRadio:!1,paymentLoading:!1,paymentVisible:!0,isRecaptchaVisible:!1,Agreements:null,PrivacyPolicy:null,Recaptcha:null,selectedMethod:null}),computed:{...e(a,["adyenVaultEnabled","getAdyenClientKey"])},watch:{selectedMethod:{handler(e){null!==e&&void 0!==this.checkout&&(this.id!==e&&this.checkout.dropinRef&&this.checkout.dropinRef.closeActivePaymentMethod(),this.storedPaymentSelected=this.id===e,"adyen-dropin-container-stored"!==e&&(this.storedPaymentMethods=this.storedPaymentMethods.map((e=>{const t=e;return t.default=!1,t}))))},immediate:!0,deep:!0}},async created(){const[e,s,a,o,d,c,m,h,y,l,u]=await r(["components.Agreements","components.PrivacyPolicy","components.Recaptcha","helpers.getPaymentExtensionAttributes","services.createPaymentGraphQl","stores.useAgreementStore","stores.useCartStore","stores.useConfigStore","stores.useCustomerStore","stores.usePaymentStore","stores.useRecaptchaStore"]);await h.getInitialConfig(),await this.getInitialConfigValues(),await m.getCart(),this.Agreements=e,this.PrivacyPolicy=s,this.Recaptcha=a,this.isRecaptchaVisible=u.isRecaptchaVisible("placeOrder"),this.selectedMethod=l.selectedMethod;const p=await this.getPaymentMethodsResponse();if(this.storedPaymentMethods=this.getFilteredStoredMethods(p),this.storedPayments&&!this.storedPaymentMethods.length)return;this.storedPaymentSelected=!0;const P=o(),g={paymentMethodsResponse:p,clientKey:await this.getAdyenClientKey,locale:h.locale,environment:t()?"live":"test",analytics:{enabled:!1},amount:{value:m.cartGrandTotal,currency:h.currencyCode},showPaymentMethods:!this.storedPayments,onAdditionalDetails:this.handleAdditionalDetails.bind(this),onError:this.handleOnError.bind(this),onSubmit:(e,t)=>{const s=c.validateAgreements(),a=u.validateToken("placeOrder");if(e.isValid=s&&a,e.isValid){const s=this.getPaymentMethod(e,P);l.paymentEmitter.emit("adyenPaymentLoading",{id:this.id,loading:!0}),d(s).then(this.setOrderId).then(i).then((e=>this.handlePaymentStatus(e,t))).catch((e=>{throw this.displayError(t,e.message).bind(this),Error(e)}))}else t.setStatus("ready")},paymentMethodsConfiguration:{card:{hasHolderName:!1,holderNameRequired:!1,enableStoreDetails:y.isLoggedIn&&this.adyenVaultEnabled,hideCVC:!1,name:"Credit or debit card"},threeDS2:{challengeWindowSize:"05"}}},S=await n(g);if(this.checkout=S.create("dropin",{showStoredPaymentMethods:this.storedPayments,showPaymentMethods:!this.storedPayments,openFirstPaymentMethod:!this.storedPaymentMethods.length,openFirstStoredPaymentMethod:this.storedPaymentMethods.length,setStatusAutomatically:!1,onSelect:this.onSelect}),this.checkout.mount(`#${this.id}`),this.storedPayments&&this.storedPaymentMethods.length){const e=document.getElementById("adyen-dropin-container-new"),t={childList:!0,subtree:!0},s=(e,t)=>{e.some((e=>e.target.classList.contains("adyen-checkout__dropin--ready")))&&(this.modifyStoredPayments(),t.disconnect())};new MutationObserver(s).observe(e,t)}l.paymentEmitter.on("adyenPaymentDisplayingError",(({id:e,isDisplaying:t})=>{this.id!==e&&(this.isErrorDisplayed=t),this.hideStoredPaymentRadio=t})),l.paymentEmitter.on("adyenPaymentLoading",(({id:e,loading:t})=>{this.id!==e&&(t?this.checkout.setStatus("loading"):this.checkout.setStatus("ready"),this.paymentLoading=t)})),l.paymentEmitter.on("adyenStoredPaymentCardSelected",(({originalId:e})=>{if(this.storedPaymentMethods=this.storedPaymentMethods.map((t=>{const s=t;return s.default=e===t.originalId,s})),e){document.getElementById(e).click(),this.selectedOriginalId=e}}))},async beforeUnmount(){const[e]=await r(["stores.usePaymentStore"]);this.checkout&&(e.paymentEmitter.all.clear(),this.checkout.unmount(),this.clearPaymentReponseCache())},methods:{...s(a,["getInitialConfigValues","getPaymentMethodsResponse","clearPaymentReponseCache"]),setOrderId(e){return this.orderId=e,e},getFilteredStoredMethods:e=>e.storedPaymentMethods?e.storedPaymentMethods.filter((e=>e.supportedShopperInteractions.includes("Ecommerce"))):[],getPaymentMethod(e){const t={code:"scheme"===e.data.paymentMethod.type?"adyen_cc":"adyen_hpp"};e.data?.paymentMethod?.storedPaymentMethodId&&(e.data.storePaymentMethod=!0);const s=JSON.stringify(e.data);return"adyen_cc"===t.code?t.adyen_additional_data_cc={cc_type:e.data.paymentMethod.brand,stateData:s,recurringProcessingModel:"CardOnFile",is_active_payment_token_enabler:!!e.data.storePaymentMethod}:t.adyen_additional_data_hpp={brand_code:e.data.paymentMethod.type,stateData:s},t},async handlePaymentStatus(e,t){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,s]=await r(["helpers.getCartSectionNames","services.refreshCustomerData"]);t.setStatus("success"),await s(e()),setTimeout((()=>this.redirectToSuccess()),3e3)}else this.displayError(t,e.message)}else e.action&&("threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened"),t.handleAction(e.action))},async handleAdditionalDetails(e,t){try{t.setStatus("loading"),document.body.classList.remove("gene-checkout-threeds-opened");const s=e.data?e.data:{};s.orderId=this.orderId;const a=await d(JSON.stringify(s));await this.handlePaymentStatus(a,t)}catch(e){const s=e.response?.data?.message;this.displayError(t,s)}},async redirectToSuccess(){const[e]=await r(["helpers.getSuccessPageUrl"]);window.location.href=e()},handleOnError(e,t){if("CANCEL"===e.name){const e={orderId:this.orderId,cancelled:!0};this.handleOnCancel(e,t)}else this.displayError(t)},async handleOnCancel(e,t){try{await d(JSON.stringify(e))}catch(e){this.displayError(t,e.response?.data?.message)}},async displayError(e,t=this.$t("errorMessages.unexpectedPaymentError")){const[s]=await r(["stores.usePaymentStore"]);s.paymentEmitter.emit("adyenPaymentDisplayingError",{id:this.id,isDisplaying:!0}),e&&e.setStatus("error",{message:t}),setTimeout((()=>{e&&e.setStatus("ready"),s.paymentEmitter.emit("adyenPaymentDisplayingError",{id:this.id,isDisplaying:!1}),s.paymentEmitter.emit("adyenPaymentLoading",{id:this.id,loading:!1}),this.storedPayments&&this.storedPaymentMethods.length&&setTimeout((()=>this.modifyStoredPayments()),0),this.updateAgreementLocation()}),3e3)},async onSelect(){const[e]=await r(["stores.usePaymentStore"]);e.selectPaymentMethod(this.id),setTimeout(this.updateAgreementLocation,0)},updateAgreementLocation(){this.agreementLocation="",setTimeout((()=>{this.agreementLocation=`.${this.methodSelectedClass}\n            .adyen-checkout__payment-method__details`}),0)},async modifyStoredPayments(){const[e]=await r(["stores.usePaymentStore"]);setTimeout((()=>{setTimeout((()=>{this.storedPaymentCardsLocation=""}),0);const t=`#${this.id} .adyen-checkout__payment-methods-list`,s=document.querySelector(t),a=this.paymentMethodTitles||s.querySelectorAll(".adyen-checkout__payment-method__header__title");this.createStyledList(s,a.length),this.storedPaymentMethods=this.storedPaymentMethods.map(((e,t)=>{const s=e;return s.originalId=a[t].id,s}));this.storedPaymentMethods.find((({originalId:e})=>e===this.selectedOriginalId))||(this.storedPaymentMethods[0].default=!0,this.selectedOriginalId=this.storedPaymentMethods[0].originalId),this.storedPaymentMethods.forEach((t=>{t.default&&e.paymentEmitter.emit("adyenStoredPaymentCardSelected",{originalId:this.selectedOriginalId})}))}),0)},createStyledList(e,t){const s=document.createElement("div");s.classList.add("adyen-checkout__payment-methods-list-styled"),s.classList.add(`adyen-checkout__payment-methods-list-styled-${t}`),e.before(s),setTimeout((()=>{this.storedPaymentCardsLocation=".adyen-checkout__payment-methods-list-styled"}),0)}}};const E=["id","data-cy"];C.render=function(e,t,s,a,n,o){const i=c("AdyenPaymentCard");return!s.storedPayments||n.storedPaymentMethods.length?(M(),m(p,{key:0},[""!==n.agreementLocation?(M(),h(u,{key:0,to:n.agreementLocation},[(M(),h(y(n.Agreements),{id:"adyenDropIn-"+(s.storedPayments?"stored":"new")},null,8,["id"])),(M(),h(y(n.PrivacyPolicy))),n.isRecaptchaVisible?(M(),h(y(n.Recaptcha),{key:0,id:"placeOrder",location:"adyenDropIn"+(s.storedPayments?"stored":"new")},null,8,["location"])):l("v-if",!0)],8,["to"])):l("v-if",!0),s.storedPayments&&""!==n.storedPaymentCardsLocation?(M(),h(u,{key:1,to:n.storedPaymentCardsLocation},[(M(!0),m(p,null,P(n.storedPaymentMethods,(e=>g((M(),h(i,{class:f({"adyen-stored-payment-selected":n.storedPaymentSelected}),key:e.id,method:e},null,8,["class","method"])),[[_,!n.isErrorDisplayed&&n.paymentVisible]]))),128))],8,["to"])):l("v-if",!0),g(S("div",{id:s.id,"data-cy":s.id},null,8,E),[[_,!n.isErrorDisplayed&&n.paymentVisible]])],64)):l("v-if",!0)},C.__file="src/components/DropIn/PaymentMethods/PaymentMethods.vue";export{C as default};
