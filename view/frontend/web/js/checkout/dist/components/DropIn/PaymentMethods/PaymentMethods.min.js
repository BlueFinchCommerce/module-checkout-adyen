import{m as e,g as t,a,u as s}from"../../../AdyenStore-DOGao2-s.min.js";import{o as n}from"../../../index-CQ188U4T.min.js";import i from"../PaymentCard/PaymentCard.min.js";import{g as o,a as d}from"../../../getAdyenPaymentDetails-CMsSkhnu.min.js";import{l as r,c,a as y,r as h,e as m,T as l,F as p,f as u,w as P,b as g,o as S,n as M}from"../../../loadFromCheckout-Cy42nNSj.min.js";import{v as f}from"../../../runtime-dom.esm-bundler-D5EIMfl5.min.js";var _={name:"AdyenPaymentMethods",props:{id:{type:String,default:"adyen-dropin-container"},storedPayments:{type:Boolean,default:!1}},emits:["adyenPaymentSelected"],data:()=>({agreementLocation:"",storedPaymentCardsLocation:"",orderId:null,storedPaymentMethods:[],storedPaymentSelected:!1,selectedOriginalId:null,paymentMethodTitles:null,methodSelectedClass:"adyen-checkout__payment-method--selected",isErrorDisplayed:!1,hideStoredPaymentRadio:!1,paymentLoading:!1,paymentVisible:!0,isRecaptchaVisible:!1,Agreements:null,PrivacyPolicy:null,Recaptcha:null,selectedMethod:null,AdyenPaymentCard:null}),computed:{...e(s,["adyenVaultEnabled","getAdyenClientKey","isAdyenVersion","recurringConfiguration"])},async created(){const[e,a,s,d,c,y,h,m,l,p,u]=await r(["components.Agreements","components.PrivacyPolicy","components.Recaptcha","helpers.getPaymentExtensionAttributes","services.createPaymentGraphQl","stores.useAgreementStore","stores.useCartStore","stores.useConfigStore","stores.useCustomerStore","stores.usePaymentStore","stores.useRecaptchaStore"]);await m.getInitialConfig(),await this.getInitialConfigValues(),await h.getCart(),this.AdyenPaymentCard=i,this.Agreements=e,this.PrivacyPolicy=a,this.Recaptcha=s,this.isRecaptchaVisible=u.isRecaptchaVisible("placeOrder"),this.selectedMethod=p.selectedMethod;const P=await this.getPaymentMethodsResponse();if(this.storedPaymentMethods=this.getFilteredStoredMethods(P),this.storedPayments&&!this.storedPaymentMethods.length)return;p.$subscribe((e=>{e?.payload?.selectedMethod&&null!==e.payload.selectedMethod&&void 0!==this.checkout&&(this.id!==e.payload.selectedMethod&&this.checkout.dropinRef&&this.checkout.dropinRef.closeActivePaymentMethod(),this.storedPaymentSelected=this.id===e.payload.selectedMethod,"adyen-dropin-container-stored"!==e.payload.selectedMethod&&(this.storedPaymentMethods=this.storedPaymentMethods.map((e=>{const t=e;return t.default=!1,t}))))})),this.storedPaymentSelected=!0;const g=d(),S={paymentMethodsResponse:P,clientKey:await this.getAdyenClientKey,locale:m.locale,environment:t()?"live":"test",analytics:{enabled:!1},amount:{value:h.cartGrandTotal,currency:m.currencyCode},showPaymentMethods:!this.storedPayments,onAdditionalDetails:this.handleAdditionalDetails.bind(this),onError:this.handleOnError.bind(this),onSubmit:async(e,t)=>{const a=y.validateAgreements(),s=await u.validateToken("placeOrder");if(e.isValid=a&&s,e.isValid){const a=this.getPaymentMethod(e,g);p.paymentEmitter.emit("adyenPaymentLoading",{id:this.id,loading:!0}),p.paymentEmitter.emit("paymentProcessing",!0),c(a).then(this.setOrderId).then(o).then((e=>this.handlePaymentStatus(e,t))).catch((e=>{throw this.displayError(t,e.message).bind(this),Error(e)}))}else t.setStatus("ready")},paymentMethodsConfiguration:{card:{hasHolderName:!1,holderNameRequired:!1,enableStoreDetails:l.isLoggedIn&&(this.isAdyenVersion("9")?"1"===this.recurringConfiguration?.adyen_cc?.enabled:this.adyenVaultEnabled),hideCVC:!1,name:"Credit or debit card"},threeDS2:{challengeWindowSize:"05"}}},M=await n(S);if(this.checkout=M.create("dropin",{showStoredPaymentMethods:this.storedPayments,showPaymentMethods:!this.storedPayments,openFirstPaymentMethod:!this.storedPaymentMethods.length,openFirstStoredPaymentMethod:this.storedPaymentMethods.length,setStatusAutomatically:!1,onSelect:this.onSelect}),this.checkout.mount(`#${this.id}`),this.storedPayments&&this.storedPaymentMethods.length){const e=document.getElementById("adyen-dropin-container-new");if(e.querySelector(".adyen-checkout__dropin--ready"))this.modifyStoredPayments();else{const t={childList:!0,subtree:!0},a=(e,t)=>{e.some((e=>e.target.classList.contains("adyen-checkout__dropin--ready")))&&(this.modifyStoredPayments(),t.disconnect())};new MutationObserver(a).observe(e,t)}}p.paymentEmitter.on("adyenPaymentDisplayingError",(({id:e,isDisplaying:t})=>{this.id!==e&&(this.isErrorDisplayed=t),this.hideStoredPaymentRadio=t})),p.paymentEmitter.on("paymentProcessing",(e=>{e?this.checkout.setStatus("loading"):this.checkout.setStatus("ready")})),p.paymentEmitter.on("adyenPaymentLoading",(({id:e,loading:t})=>{this.id!==e&&(t?this.checkout.setStatus("loading"):this.checkout.setStatus("ready"),this.paymentLoading=t)})),p.paymentEmitter.on("adyenStoredPaymentCardSelected",(({originalId:e})=>{if(this.storedPaymentMethods=this.storedPaymentMethods.map((t=>{const a=t;return a.default=e===t.originalId,a})),e){document.getElementById(e).click(),this.selectedOriginalId=e}})),p.paymentEmitter.on("paymentMethodSelected",(({type:e})=>{e.includes("adyen")||this.checkout.dropinRef.closeActivePaymentMethod()}))},async beforeUnmount(){const[e]=await r(["stores.usePaymentStore"]);this.checkout&&(e.paymentEmitter.all.clear(),this.checkout.unmount(),this.clearPaymentReponseCache())},methods:{...a(s,["getInitialConfigValues","getPaymentMethodsResponse","clearPaymentReponseCache"]),setOrderId(e){return this.orderId=e,e},getFilteredStoredMethods:e=>e.storedPaymentMethods?e.storedPaymentMethods.filter((e=>e.supportedShopperInteractions.includes("Ecommerce"))):[],getPaymentMethod(e){const t={};"scheme"===e.data.paymentMethod.type?t.code="adyen_cc":this.isAdyenVersion("9")?t.code=`adyen_${e.data.paymentMethod.type}`:t.code="adyen_hpp",e.data?.paymentMethod?.storedPaymentMethodId&&(e.data.storePaymentMethod=!0);const a=JSON.stringify(e.data);if("adyen_cc"===t.code)t.adyen_additional_data_cc={cc_type:e.data.paymentMethod.brand,stateData:a,recurringProcessingModel:this.isAdyenVersion("9")?this.recurringConfiguration?.adyen_cc?.recurringProcessingModel:"CardOnFile",is_active_payment_token_enabler:!!e.data.storePaymentMethod};else{t[this.isAdyenVersion("9")?"adyen_additional_data":"adyen_additional_data_hpp"]={brand_code:e.data.paymentMethod.type,stateData:a}}return t},async handlePaymentStatus(e,t){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,a]=await r(["helpers.getCartSectionNames","services.refreshCustomerData"]);t.setStatus("success"),await a(e()),setTimeout((()=>this.redirectToSuccess()),3e3)}else this.displayError(t,e.message)}else e.action&&("threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened"),t.handleAction(e.action))},async handleAdditionalDetails(e,t){try{t.setStatus("loading"),document.body.classList.remove("gene-checkout-threeds-opened");const a=e.data?e.data:{};a.orderId=this.orderId;const s=await d(JSON.stringify(a));await this.handlePaymentStatus(s,t)}catch(e){const a=e.response?.data?.message;this.displayError(t,a)}},async redirectToSuccess(){const[e]=await r(["helpers.getSuccessPageUrl"]);window.location.href=e()},handleOnError(e,t){if("CANCEL"===e.name){const e={orderId:this.orderId,details:{cancelled:!0}};this.handleOnCancel(e,t)}else this.displayError(t)},async handleOnCancel(e,t){try{await d(JSON.stringify(e))}catch(e){this.displayError(t,e.response?.data?.message)}},async displayError(e,t=this.$t("errorMessages.unexpectedPaymentError")){const[a]=await r(["stores.usePaymentStore"]);a.paymentEmitter.emit("adyenPaymentDisplayingError",{id:this.id,isDisplaying:!0}),a.paymentEmitter.emit("paymentProcessing",!1),e&&e.setStatus("error",{message:t}),setTimeout((()=>{e&&e.setStatus("ready"),a.paymentEmitter.emit("adyenPaymentDisplayingError",{id:this.id,isDisplaying:!1}),a.paymentEmitter.emit("adyenPaymentLoading",{id:this.id,loading:!1}),this.storedPayments&&this.storedPaymentMethods.length&&setTimeout((()=>this.modifyStoredPayments()),0),this.updateAgreementLocation()}),3e3)},async onSelect(e){const[t]=await r(["stores.usePaymentStore"]);t.paymentEmitter.emit("paymentMethodSelected",{type:`adyen_${e.props.type}`}),t.selectPaymentMethod(this.id),setTimeout(this.updateAgreementLocation,0)},updateAgreementLocation(){this.agreementLocation="",setTimeout((()=>{this.agreementLocation=`.${this.methodSelectedClass}\n            .adyen-checkout__payment-method__details`}),0)},async modifyStoredPayments(){const[e]=await r(["stores.usePaymentStore"]);setTimeout((()=>{setTimeout((()=>{this.storedPaymentCardsLocation=""}),0);const t=`#${this.id} .adyen-checkout__payment-methods-list`,a=document.querySelector(t),s=this.paymentMethodTitles||a.querySelectorAll(".adyen-checkout__payment-method__header__title");this.createStyledList(a,s.length),this.storedPaymentMethods=this.storedPaymentMethods.map(((e,t)=>{const a=e;return a.originalId=s[t].id,a}));this.storedPaymentMethods.find((({originalId:e})=>e===this.selectedOriginalId))||(this.storedPaymentMethods[0].default=!0,this.selectedOriginalId=this.storedPaymentMethods[0].originalId),this.storedPaymentMethods.forEach((t=>{t.default&&e.paymentEmitter.emit("adyenStoredPaymentCardSelected",{originalId:this.selectedOriginalId})}))}),0)},createStyledList(e,t){const a=document.createElement("div");a.classList.add("adyen-checkout__payment-methods-list-styled"),a.classList.add(`adyen-checkout__payment-methods-list-styled-${t}`),e.before(a),setTimeout((()=>{this.storedPaymentCardsLocation=".adyen-checkout__payment-methods-list-styled"}),0)}}};const C=["id","data-cy"];_.render=function(e,t,a,s,n,i){return!a.storedPayments||n.storedPaymentMethods.length>0?(S(),c(p,{key:0},[""!==n.agreementLocation?(S(),y(l,{key:0,to:n.agreementLocation},[(S(),y(h(n.Agreements),{id:"adyenDropIn-"+(a.storedPayments?"stored":"new")},null,8,["id"])),(S(),y(h(n.PrivacyPolicy))),n.isRecaptchaVisible?(S(),y(h(n.Recaptcha),{key:0,id:"placeOrder",location:"adyenDropIn"+(a.storedPayments?"stored":"new")},null,8,["location"])):m("v-if",!0)],8,["to"])):m("v-if",!0),a.storedPayments&&""!==n.storedPaymentCardsLocation?(S(),y(l,{key:1,to:n.storedPaymentCardsLocation},[(S(!0),c(p,null,u(n.storedPaymentMethods,(e=>P((S(),y(h(n.AdyenPaymentCard),{key:e.id,class:M({"adyen-stored-payment-selected":n.storedPaymentSelected}),method:e},null,8,["class","method"])),[[f,!n.isErrorDisplayed&&n.paymentVisible]]))),128))],8,["to"])):m("v-if",!0),P(g("div",{id:a.id,"data-cy":a.id},null,8,C),[[f,!n.isErrorDisplayed&&n.paymentVisible]])],64)):m("v-if",!0)},_.__file="src/components/DropIn/PaymentMethods/PaymentMethods.vue";export{_ as default};
