import{m as e,a as t}from"../../pinia-CTzb92xA.min.js";import{o as a}from"../../index-CQ188U4T.min.js";import{g as i,u as n}from"../../AdyenStore-Cj1di2dy.min.js";import{l as o}from"../../loadFromCheckout-BMerKOqv.min.js";import{c as s,n as r,e as p,o as l}from"../../runtime-core.esm-bundler-D9EqWZvo.min.js";var d={name:"AdyenApplePay",data:()=>({applePayAvailable:!1,applePayTotal:"",applPaySubtotaltitle:"",applePayShippingStepTitle:"",applePayNoShippingMethods:"",applePayLoaded:!0,key:"adyenApplePay"}),computed:{...e(n,["getAdyenClientKey","isAdyenVersion"])},async created(){if(!window.ApplePaySession||!window.ApplePaySession.canMakePayments)return;const[e,t,n]=await o(["stores.useCartStore","stores.useConfigStore","stores.usePaymentStore"]);n.addExpressMethod(this.key),this.applePayLoaded=!1,this.applePayAvailable=!0,await t.getInitialConfig(),await this.getInitialConfigValues(),await e.getCart();const s=await this.getPaymentMethodsResponse(),r=this.getApplePayMethod(s);if(!r)return this.applePayLoaded=!0,void n.removeExpressMethod(this.key);const p=await this.getApplePayConfiguration(r),l={configStore:this.locale,environment:i()?"LIVE":"TEST",analytics:{enabled:!1},risk:{enabled:!1},clientKey:this.getAdyenClientKey},d=(await a(l)).create("applepay",p);d.isAvailable().then((()=>{d.mount("#adyen-apple-pay"),this.applePayLoaded=!0})).catch((()=>{n.removeExpressMethod(this.key),console.warn("Apple Pay is not available")})),this.applePayTotal=t.websiteName,this.applPaySubtotaltitle=this.$t("orderSummary.subtotalTitle"),this.applePayShippingStepTitle=this.$t("progressBar.shippingStepTitle"),this.applePayNoShippingMethods=this.$t("errorMessages.applePayNoShippingMethods")},methods:{...t(n,["getInitialConfigValues","getPaymentMethodsResponse"]),getApplePayMethod:e=>e.paymentMethods.find((({type:e})=>"applepay"===e)),async getApplePayConfiguration(e){const[t,a]=await o(["stores.useCartStore","stores.useConfigStore"]),n=["name","email","phone"];return t.cart.is_virtual||n.push("postalAddress"),{amount:{value:parseFloat(t.cartGrandTotal).toFixed(2),currency:a.currencyCode},currencyCode:a.currencyCode,countryCode:a.countryCode,totalPriceLabel:a.websiteName,environment:i()?"LIVE":"TEST",configuration:{domainName:window.location.hostname,merchantName:e.configuration.merchantName,merchantId:e.configuration.merchantId},requiredShippingContactFields:n,requiredBillingContactFields:["postalAddress","name"],onAuthorized:this.onAuthorized.bind(this),...t.cart.is_virtual?{}:{onShippingContactSelected:this.onShippingContactSelect.bind(this),onShippingMethodSelected:this.onShippingMethodSelect.bind(this),shippingMethods:[]},onClick:(t,a)=>this.onClick(t,a,e.type),onSubmit:()=>{}}},async onClick(e,t,a){const[i,n,s]=await o(["helpers.expressPaymentOnClickDataLayer","stores.useAgreementStore","stores.useRecaptchaStore"]),r=n.validateAgreements(),p=s.validateToken("placeOrder");return!(!r||!p)&&(i(a),e())},async onAuthorized(e,t,a){const[i,n,s,r,p,l,d]=await o(["helpers.getCartSectionNames","helpers.getSuccessPageUrl","services.createPaymentGraphQl","services.refreshCustomerData","services.setAddressesOnCart","stores.useCartStore","stores.useConfigStore"]),{shippingContact:c,billingContact:h}=a.payment,y=c.emailAddress,m=c.phoneNumber;let u=null;l.cart.is_virtual||(u=await this.mapAddress(c,y,m));const g=await this.mapAddress(h,y,m);if(d.countries.some((({id:e})=>e===g.country_code)))try{p(u,g,y).then((()=>{const e=JSON.stringify({paymentMethod:{applePayToken:btoa(JSON.stringify(a.payment.token.paymentData)),type:"applepay"},browserInfo:this.browserInfo}),t=this.isAdyenVersion("8")?"adyen_additional_data_hpp":"adyen_additional_data",i={code:this.isAdyenVersion("8")?"adyen_hpp":"adyen_applepay",[t]:{brand_code:"applepay",stateData:e}};return s(i)})).then((async()=>{e(window.ApplePaySession.STATUS_SUCCESS),await r(i()),window.location.href=n()}))}catch(t){const a={errors:[new window.ApplePayError("unknown","country",t.message)]};e(a)}else t(window.ApplePaySession.STATUS_FAILURE)},async onShippingContactSelect(e,t,a){const[i,n,s,r]=await o(["services.getShippingMethods","stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]),p={city:a.shippingContact.locality,region:a.shippingContact.administrativeArea,region_id:s.getRegionId(a.shippingContact.countryCode,a.shippingContact.administrativeArea),country_code:a.shippingContact.countryCode.toUpperCase(),postcode:a.shippingContact.postalCode,street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};this.address=p;const l=(await i(p)).shipping_addresses[0].available_shipping_methods.filter((({method_code:e})=>"nominated_delivery"!==e));if(!l.length){return void e({errors:[new window.ApplePayError("addressUnserviceable","postalAddress",this.applePayNoShippingMethods)],newTotal:{label:this.applePayTotal,amount:"0.00",type:"pending"}})}const d=l[0];await r.submitShippingInfo(d.carrier_code,d.method_code);const c={newShippingMethods:this.mapShippingMethods(l),newTotal:{label:this.applePayTotal,amount:parseFloat(n.cartGrandTotal/100).toFixed(2)},newLineItems:[{type:"final",label:"Subtotal",amount:n.cart.prices.subtotal_including_tax.value.toString()},{type:"final",label:"Shipping",amount:d.amount.value.toString()}]};n.cartDiscountTotal&&c.newLineItems.push({type:"final",label:"Discount",amount:n.cartDiscountTotal.toString()}),e(c)},async onShippingMethodSelect(e,t,a){const[i,n]=await o(["stores.useCartStore","stores.useShippingMethodsStore"]),s=n.shippingMethods.find((({method_code:e})=>e===a.shippingMethod.identifier));await n.submitShippingInfo(s.carrier_code,s.method_code);const r={newTotal:{label:this.applePayTotal,amount:parseFloat(i.cartGrandTotal/100).toFixed(2)},newLineItems:[{type:"final",label:"Subtotal",amount:i.cart.prices.subtotal_including_tax.value.toString()},{type:"final",label:"Shipping",amount:s.amount.value.toString()}]};i.cartDiscountTotal&&r.newLineItems.push({type:"final",label:"Discount",amount:i.cartDiscountTotal.toString()}),e(r)},mapShippingMethods:e=>e.map((e=>({label:e.method_title,detail:e.carrier_title||"",amount:e.amount.toString(),identifier:e.method_code,carrierCode:e.carrier_code}))),async mapAddress(e,t,a){const[i]=await o(["stores.useConfigStore"]),n=i.getRegionId(e.countryCode.toUpperCase(),e.administrativeArea);return{email:t,telephone:a,firstname:e.givenName,lastname:e.familyName,company:e.company||"",street:e.addressLines,city:e.locality,country_code:e.countryCode.toUpperCase(),postcode:e.postalCode,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...n?{region_id:n}:{}}}}}};d.render=function(e,t,a,i,n,o){return n.applePayAvailable?(l(),s("div",{key:0,id:"adyen-apple-pay",class:r(n.applePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-adyenApplePay"},null,2)):p("v-if",!0)},d.__file="src/components/ApplePay/ApplePay.vue";export{d as default};
