import{m as e,g as t,a,u as i}from"../../AdyenStore-Bj72Daxq.min.js";import{o}from"../../index-CQ188U4T.min.js";import{c as n}from"../../clearCartAddresses-B1P6_Nur.min.js";import{l as s,c as r,n as p,e as l,o as d}from"../../loadFromCheckout-Cy42nNSj.min.js";var c={name:"AdyenApplePay",data:()=>({applePayAvailable:!1,applePayTotal:"",applPaySubtotaltitle:"",applePayShippingStepTitle:"",applePayNoShippingMethods:"",applePayLoaded:!0,key:"adyenApplePay"}),computed:{...e(i,["getAdyenClientKey","isAdyenVersion"])},async created(){if(!window.ApplePaySession||!window.ApplePaySession.canMakePayments)return;const[e,a,i]=await s(["stores.useCartStore","stores.useConfigStore","stores.usePaymentStore"]);i.addExpressMethod(this.key),this.applePayLoaded=!1,this.applePayAvailable=!0,await a.getInitialConfig(),await this.getInitialConfigValues(),await e.getCart();const n=await this.getPaymentMethodsResponse(),r=this.getApplePayMethod(n);if(!r)return this.applePayLoaded=!0,void i.removeExpressMethod(this.key);const p=await this.getApplePayConfiguration(r),l={configStore:this.locale,environment:t()?"LIVE":"TEST",analytics:{enabled:!1},risk:{enabled:!1},clientKey:await this.getAdyenClientKey},d=(await o(l)).create("applepay",p);d.isAvailable().then((()=>{d.mount("#adyen-apple-pay"),this.applePayLoaded=!0})).catch((()=>{i.removeExpressMethod(this.key),console.warn("Apple Pay is not available")})),this.applePayTotal=a.websiteName,this.applPaySubtotaltitle=this.$t("orderSummary.subtotalTitle"),this.applePayShippingStepTitle=this.$t("progressBar.shippingStepTitle"),this.applePayNoShippingMethods=this.$t("errorMessages.applePayNoShippingMethods")},methods:{...a(i,["getInitialConfigValues","getPaymentMethodsResponse"]),getApplePayMethod:e=>e.paymentMethods.find((({type:e})=>"applepay"===e)),async getApplePayConfiguration(e){const[a,i]=await s(["stores.useCartStore","stores.useConfigStore"]),o=["name","email","phone"];return a.cart.is_virtual||o.push("postalAddress"),{amount:{value:parseFloat(a.cartGrandTotal).toFixed(2),currency:i.currencyCode},currencyCode:i.currencyCode,countryCode:i.countryCode,totalPriceLabel:i.websiteName,environment:t()?"LIVE":"TEST",configuration:{domainName:window.location.hostname,merchantName:e.configuration.merchantName,merchantId:e.configuration.merchantId},requiredShippingContactFields:o,requiredBillingContactFields:["postalAddress","name"],onAuthorized:this.onAuthorized.bind(this),...a.cart.is_virtual?{}:{onShippingContactSelected:this.onShippingContactSelect.bind(this),onShippingMethodSelected:this.onShippingMethodSelect.bind(this),shippingMethods:[]},onClick:(t,a)=>this.onClick(t,a,e.type),onSubmit:()=>{},onError:async()=>{n()}}},async onClick(e,t,a){const[i,o,n]=await s(["helpers.expressPaymentOnClickDataLayer","stores.useAgreementStore","stores.useRecaptchaStore"]),r=o.validateAgreements(),p=n.validateToken("placeOrder");return!(!r||!p)&&(i(a),e())},async onAuthorized(e,t,a){const[i,o,n,r,p,l,d]=await s(["helpers.getCartSectionNames","helpers.getSuccessPageUrl","services.createPaymentGraphQl","services.refreshCustomerData","services.setAddressesOnCart","stores.useCartStore","stores.useConfigStore"]),{shippingContact:c,billingContact:h}=a.payment,y=c.emailAddress,m=c.phoneNumber;let u=null;l.cart.is_virtual||(u=await this.mapAddress(c,y,m));const g=await this.mapAddress(h,y,m);if(d.countries.some((({id:e})=>e===g.country_code)))try{p(u,g,y).then((()=>{const e=JSON.stringify({paymentMethod:{applePayToken:btoa(JSON.stringify(a.payment.token.paymentData)),type:"applepay"},browserInfo:this.browserInfo}),t=this.isAdyenVersion("9")?"adyen_additional_data":"adyen_additional_data_hpp",i={code:this.isAdyenVersion("9")?"adyen_applepay":"adyen_hpp",[t]:{brand_code:"applepay",stateData:e}};return n(i)})).then((async()=>{e(window.ApplePaySession.STATUS_SUCCESS),await r(i()),window.location.href=o()}))}catch(t){const a={errors:[new window.ApplePayError("unknown","country",t.message)]};e(a)}else t(window.ApplePaySession.STATUS_FAILURE)},async onShippingContactSelect(e,t,a){const[i,o,n,r]=await s(["services.getShippingMethods","stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]),p={city:a.shippingContact.locality,region:a.shippingContact.administrativeArea,region_id:n.getRegionId(a.shippingContact.countryCode,a.shippingContact.administrativeArea),country_code:a.shippingContact.countryCode.toUpperCase(),postcode:a.shippingContact.postalCode,street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};this.address=p;const l=(await i(p)).shipping_addresses[0].available_shipping_methods.filter((({method_code:e})=>"nominated_delivery"!==e));if(!l.length){return void e({errors:[new window.ApplePayError("addressUnserviceable","postalAddress",this.applePayNoShippingMethods)],newTotal:{label:this.applePayTotal,amount:"0.00",type:"pending"}})}const d=l[0];await r.submitShippingInfo(d.carrier_code,d.method_code);const c={newShippingMethods:this.mapShippingMethods(l),newTotal:{label:this.applePayTotal,amount:parseFloat(o.cartGrandTotal/100).toFixed(2)},newLineItems:[{type:"final",label:"Subtotal",amount:o.cart.prices.subtotal_including_tax.value.toString()},{type:"final",label:"Shipping",amount:d.amount.value.toString()}]};o.cartDiscountTotal&&c.newLineItems.push({type:"final",label:"Discount",amount:o.cartDiscountTotal.toString()}),e(c)},async onShippingMethodSelect(e,t,a){const[i,o]=await s(["stores.useCartStore","stores.useShippingMethodsStore"]),n=o.shippingMethods.find((({method_code:e})=>e===a.shippingMethod.identifier));await o.submitShippingInfo(n.carrier_code,n.method_code);const r={newTotal:{label:this.applePayTotal,amount:parseFloat(i.cartGrandTotal/100).toFixed(2)},newLineItems:[{type:"final",label:"Subtotal",amount:i.cart.prices.subtotal_including_tax.value.toString()},{type:"final",label:"Shipping",amount:n.amount.value.toString()}]};i.cartDiscountTotal&&r.newLineItems.push({type:"final",label:"Discount",amount:i.cartDiscountTotal.toString()}),e(r)},mapShippingMethods:e=>e.map((e=>({label:e.method_title,detail:e.carrier_title||"",amount:e.amount.toString(),identifier:e.method_code,carrierCode:e.carrier_code}))),async mapAddress(e,t,a){const[i]=await s(["stores.useConfigStore"]),o=i.getRegionId(e.countryCode.toUpperCase(),e.administrativeArea);return{email:t,telephone:a,firstname:e.givenName,lastname:e.familyName,company:e.company||"",street:e.addressLines,city:e.locality,country_code:e.countryCode.toUpperCase(),postcode:e.postalCode,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...o?{region_id:o}:{}}}}}};c.render=function(e,t,a,i,o,n){return o.applePayAvailable?(d(),r("div",{key:0,id:"adyen-apple-pay",class:p(o.applePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-adyenApplePay"},null,2)):l("v-if",!0)},c.__file="src/components/ApplePay/ApplePay.vue";export{c as default};
