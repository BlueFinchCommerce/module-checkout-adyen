import{a as e}from"../../pinia-CTzb92xA.min.js";import{r as t}from"../../index-Dc8nEF8k.min.js";import{g as a,u as s}from"../../AdyenStore-Ck-aKvZn.min.js";import{g as o,v as i}from"../../getAdyenPaymentStatus-BXPlZruE.min.js";import{l as n}from"../../loadFromCheckout-BMerKOqv.min.js";import{c as r,b as d,n as c,w as h,F as g,o as l}from"../../runtime-core.esm-bundler-D9EqWZvo.min.js";var p={name:"AdyenGooglePay",data:()=>({browserInfo:{},googlePayLoaded:!1,googlePayNoShippingMethods:"",key:"adyenGooglePay",orderId:null,threeDSVisible:!1}),async created(){const[e,s,o]=await n(["stores.useCartStore","stores.useConfigStore","stores.usePaymentStore"]);o.addExpressMethod(this.key),await s.getInitialConfig(),await this.getInitialConfigValues(),await e.getCart();const i=await this.getPaymentMethodsResponse();if(!this.getGooglePayMethod(i))return this.googlePayLoaded=!0,void o.removeExpressMethod(this.key);const r=i.paymentMethods.find((e=>"paywithgoogle"===e.type||"googlepay"===e.type));if(!r)return o.removeExpressMethod(this.key),void(this.googlePayLoaded=!0);const d=await this.getGooglePayConfiguration(r),c={paymentMethodsResponse:i,locale:s.locale,environment:a()?"LIVE":"TEST",analytics:{enabled:!1}};this.checkout=await t(c);const h=this.checkout.create("googlepay",d);h.isAvailable().then((()=>{h.mount("#adyen-google-pay"),this.googlePayLoaded=!0})).catch((()=>{o.removeExpressMethod(this.key),console.warn("Google Pay is not available")})),this.browserInfo=h.browserInfo,this.googlePayNoShippingMethods=this.$t("errorMessages.googlePayNoShippingMethods")},mounted(){const e=document.createElement("script");e.setAttribute("src","https://pay.google.com/gp/p/js/pay.js"),document.head.appendChild(e)},methods:{...e(s,["getInitialConfigValues","getPaymentMethodsResponse"]),setOrderId(e){return this.orderId=e,e},async setLoadingState(e){const[t]=await n("stores.useLoadingStore");t.setLoadingState(e)},async setErrorMessage(e){const[t]=await n("stores.usePaymentStore");t.setErrorMessage(e)},getGooglePayMethod:e=>e.paymentMethods.find((({type:e})=>"paywithgoogle"===e||"googlepay")),async handeOnAuthorized(){try{document.body.classList.remove("gene-checkout-threeds-opened"),this.setLoadingState(!0);const e=await o(this.orderId);this.handleAdyenResponse(e)}catch(e){this.setLoadingState(!1);const t=e.response?.data?.message;this.setErrorMessage(t)}},async getGooglePayConfiguration(e){const[t,s]=await n(["stores.useCartStore","stores.useConfigStore"]),o=["PAYMENT_AUTHORIZATION"];return t.cart.is_virtual||o.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),{amount:{value:t.cartGrandTotal,currency:s.currencyCode},countryCode:s.countryCode,environment:a()?"LIVE":"TEST",paymentDataCallbacks:{onPaymentAuthorized:this.onPaymentAuthorized,...t.cart.is_virtual?{}:{onPaymentDataChanged:this.onPaymentDataChanged}},emailRequired:!0,shippingAddressRequired:!t.cart.is_virtual,shippingAddressParameters:{phoneNumberRequired:!t.cart.is_virtual},billingAddressRequired:!0,billingAddressParameters:{format:"FULL",phoneNumberRequired:!0},shippingOptionRequired:!t.cart.is_virtual,callbackIntents:o,configuration:{gatewayMerchantId:e.configuration.gatewayMerchantId,merchantId:e.configuration.merchantId},onAuthorized:this.handeOnAuthorized,onClick:(t,a)=>this.onClick(t,a,e.type),onSubmit:()=>{},onError:()=>{this.setLoadingState(!1)}}},async onClick(e,t,a){const[s,o,i]=await n(["helpers.expressPaymentOnClickDataLayer","stores.useAgreementStore","stores.useRecaptchaStore"]);this.setErrorMessage("");const r=o.validateAgreements(),d=i.validateToken("placeOrder");return!(!r||!d)&&(s(a),this.setLoadingState(!0),e())},onPaymentDataChanged(e){return new Promise((async t=>{const[a,s,o,i,r]=await n(["helpers.formatPrice","services.getShippingMethods","stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]);s({city:e.shippingAddress.locality,country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:i.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"}).then((async s=>{const n=s.shipping_addresses[0].available_shipping_methods,d=n.map((e=>{const t=e.carrier_title?`${a(e.price_incl_tax.value)} ${e.carrier_title}`:a(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!d.length)return void t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.googlePayNoShippingMethods,intent:"SHIPPING_ADDRESS"}});const c="shipping_option_unselected"===e.shippingOptionData.id?n[0]:n.find((({method_code:t})=>t===e.shippingOptionData.id))||n[0];await r.submitShippingInfo(c.carrier_code,c.method_code),this.setLoadingState(!0);const h={newShippingOptionParameters:{defaultSelectedOptionId:c.method_code,shippingOptions:d},newTransactionInfo:{displayItems:[{label:"Shipping",type:"LINE_ITEM",price:o.cart.shipping_addresses[0].selected_shipping_method.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:i.countryCode}};t(h)})).catch((e=>{t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:e.message,intent:"SHIPPING_ADDRESS"}})}))}))},onPaymentAuthorized(e){return new Promise((async t=>{const[a,s,o]=await n(["services.createPaymentGraphQl","services.setAddressesOnCart","stores.useCartStore"]);if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void t({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const{email:i}=e,{billingAddress:r}=e.paymentMethodData.info,{phoneNumber:d}=r,c=await this.mapAddress(r,i,d);let h=null;if(!o.cart.is_virtual){const{shippingAddress:t}=e,{phoneNumber:a}=t;h=await this.mapAddress(t,i,a)}s(h,c,i).then((()=>({code:"adyen_hpp",adyen_additional_data_hpp:{brand_code:"googlepay",stateData:JSON.stringify({paymentMethod:{googlePayCardNetwork:e.paymentMethodData.info.cardNetwork,googlePayToken:e.paymentMethodData.tokenizationData.token,type:"googlepay"},browserInfo:this.browserInfo})}}))).then(a).then((e=>{this.setOrderId(e),t({transactionState:"SUCCESS"})})).catch((e=>{t({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}))}))},async handleAdyenResponse(e){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,t,a]=await n(["helpers.getCartSectionNames","helpers.getSuccessPageUrl","services.refreshCustomerData"]);await a(e()),window.location.href=t()}else this.setLoadingState(!1),this.setErrorMessage(e.message)}else if(e.action){this.setErrorMessage(e.message),"threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened");const t={challengeWindowSize:"05"};this.threeDSVisible=!0,this.checkout.createFromAction(e.action,t).mount("#adyen-threeds-container")}},async mapAddress(e,t,a){const[s]=await n("stores.useConfigStore"),[o,...i]=e.name.split(" "),r=s.getRegionId(e.countryCode,e.administrativeArea);return{street:[e.address1,e.address2],company:e.company||"",postcode:e.postalCode,country_code:e.countryCode,email:t,firstname:o,lastname:i.length?i.join(" "):"UNKNOWN",city:e.locality,telephone:a,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...r?{region_id:r}:{}}}}}};const m={id:"adyen-threeds-container"};p.render=function(e,t,a,s,o,n){return l(),r(g,null,[d("div",{id:"adyen-google-pay",class:c(o.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-adyenGooglePay"},null,2),h(d("div",m,null,512),[[i,o.threeDSVisible]])],64)},p.__file="src/components/GooglePay/GooglePay.vue";export{p as default};
