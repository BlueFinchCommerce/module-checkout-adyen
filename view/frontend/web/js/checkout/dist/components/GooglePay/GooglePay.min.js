import{m as e,g as t,a,u as s}from"../../AdyenStore-C08mTpGX.min.js";import{o}from"../../index-CQ188U4T.min.js";import{c as i}from"../../clearCartAddresses-B1P6_Nur.min.js";import{g as n,a as r}from"../../getAdyenPaymentDetails-D2a9vNEp.min.js";import{l as d,c,b as h,n as l,w as g,F as p,o as y}from"../../loadFromCheckout-Cy42nNSj.min.js";import{v as m}from"../../runtime-dom.esm-bundler-D5EIMfl5.min.js";var u={name:"AdyenGooglePay",data:()=>({browserInfo:{},googlePayLoaded:!1,googlePayNoShippingMethods:"",key:"adyenGooglePay",orderId:null,threeDSVisible:!1}),computed:{...e(s,["getAdyenClientKey","isAdyenVersion"])},async created(){const[e,a,s]=await d(["stores.useCartStore","stores.useConfigStore","stores.usePaymentStore"]);s.addExpressMethod(this.key),await a.getInitialConfig(),await this.getInitialConfigValues(),await e.getCart();const i=await this.getPaymentMethodsResponse();if(!this.getGooglePayMethod(i))return this.googlePayLoaded=!0,void s.removeExpressMethod(this.key);const n=i.paymentMethods.find((e=>"paywithgoogle"===e.type||"googlepay"===e.type));if(!n)return s.removeExpressMethod(this.key),void(this.googlePayLoaded=!0);const r=await this.getGooglePayConfiguration(n),c={paymentMethodsResponse:i,clientKey:await this.getAdyenClientKey,locale:a.locale,environment:t()?"LIVE":"TEST",analytics:{enabled:!1},onAdditionalDetails:this.onAdditionalDetails};this.checkout=await o(c);const h=this.checkout.create("googlepay",r);h.isAvailable().then((()=>{h.mount("#adyen-google-pay"),this.googlePayLoaded=!0})).catch((()=>{s.removeExpressMethod(this.key),console.warn("Google Pay is not available")})),this.browserInfo=h.browserInfo,this.googlePayNoShippingMethods=this.$t("errorMessages.googlePayNoShippingMethods")},mounted(){const e=document.createElement("script");e.setAttribute("src","https://pay.google.com/gp/p/js/pay.js"),document.head.appendChild(e)},methods:{...a(s,["getInitialConfigValues","getPaymentMethodsResponse"]),setOrderId(e){return this.orderId=e,e},async setLoadingState(e){const[t]=await d("stores.useLoadingStore");t.setLoadingState(e)},async setErrorMessage(e){const[t]=await d("stores.usePaymentStore");t.setErrorMessage(e)},getGooglePayMethod:e=>e.paymentMethods.find((({type:e})=>"paywithgoogle"===e||"googlepay")),async handeOnAuthorized(){try{document.body.classList.remove("gene-checkout-threeds-opened"),this.setLoadingState(!0);const e=await n(this.orderId);this.handleAdyenResponse(e)}catch(e){this.setLoadingState(!1);const t=e.response?.data?.message;this.setErrorMessage(t)}},async getGooglePayConfiguration(e){const[a,s]=await d(["stores.useCartStore","stores.useConfigStore"]),o=["PAYMENT_AUTHORIZATION"];return a.cart.is_virtual||o.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),{amount:{value:a.cartGrandTotal,currency:s.currencyCode},countryCode:s.countryCode,environment:t()?"LIVE":"TEST",paymentDataCallbacks:{onPaymentAuthorized:this.onPaymentAuthorized,...a.cart.is_virtual?{}:{onPaymentDataChanged:this.onPaymentDataChanged}},emailRequired:!0,shippingAddressRequired:!a.cart.is_virtual,shippingAddressParameters:{phoneNumberRequired:!a.cart.is_virtual},billingAddressRequired:!0,billingAddressParameters:{format:"FULL",phoneNumberRequired:!0},shippingOptionRequired:!a.cart.is_virtual,callbackIntents:o,configuration:{gatewayMerchantId:e.configuration.gatewayMerchantId,merchantId:e.configuration.merchantId},onAuthorized:this.handeOnAuthorized,onClick:(t,a)=>this.onClick(t,a,e.type),onSubmit:()=>{},onError:async()=>{i(),this.setLoadingState(!1)},onCancel:async()=>{i(),this.setLoadingState(!1)}}},async onClick(e,t,a){const[s,o,i]=await d(["helpers.expressPaymentOnClickDataLayer","stores.useAgreementStore","stores.useRecaptchaStore"]);this.setErrorMessage("");const n=o.validateAgreements(),r=i.validateToken("placeOrder");return!(!n||!r)&&(s(a),this.setLoadingState(!0),e())},onPaymentDataChanged(e){return new Promise((async t=>{const[a,s,o,i,n]=await d(["helpers.formatPrice","services.getShippingMethods","stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]);s({city:e.shippingAddress.locality,country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:i.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"}).then((async s=>{const r=s.shipping_addresses[0].available_shipping_methods,d=r.map((e=>{const t=e.carrier_title?`${a(e.price_incl_tax.value)} ${e.carrier_title}`:a(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!d.length)return void t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.googlePayNoShippingMethods,intent:"SHIPPING_ADDRESS"}});const c="shipping_option_unselected"===e.shippingOptionData.id?r[0]:r.find((({method_code:t})=>t===e.shippingOptionData.id))||r[0];await n.submitShippingInfo(c.carrier_code,c.method_code),this.setLoadingState(!0);const h={newShippingOptionParameters:{defaultSelectedOptionId:c.method_code,shippingOptions:d},newTransactionInfo:{displayItems:[{label:"Shipping",type:"LINE_ITEM",price:o.cart.shipping_addresses[0].selected_shipping_method.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:i.countryCode}};t(h)})).catch((e=>{t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:e.message,intent:"SHIPPING_ADDRESS"}})}))}))},onPaymentAuthorized(e){return new Promise((async t=>{const[a,s,o]=await d(["services.createPaymentGraphQl","services.setAddressesOnCart","stores.useCartStore"]);if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void t({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const{email:i}=e,{billingAddress:n}=e.paymentMethodData.info,{phoneNumber:r}=n,c=await this.mapAddress(n,i,r);let h=null;if(!o.cart.is_virtual){const{shippingAddress:t}=e,{phoneNumber:a}=t;h=await this.mapAddress(t,i,a)}s(h,c,i).then((()=>{const t=JSON.stringify({paymentMethod:{googlePayCardNetwork:e.paymentMethodData.info.cardNetwork,googlePayToken:e.paymentMethodData.tokenizationData.token,type:"googlepay"},browserInfo:this.browserInfo}),a=this.isAdyenVersion("9")?"adyen_additional_data":"adyen_additional_data_hpp";return{code:this.isAdyenVersion("9")?"adyen_googlepay":"adyen_hpp",[a]:{brand_code:"googlepay",stateData:t}}})).then(a).then((e=>{this.setOrderId(e),t({transactionState:"SUCCESS"})})).catch((e=>{t({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}))}))},async handleAdyenResponse(e){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,t,a]=await d(["helpers.getCartSectionNames","helpers.getSuccessPageUrl","services.refreshCustomerData"]);await a(e()),window.location.href=t()}else this.setLoadingState(!1)}else if(e.action){"threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened");const t={challengeWindowSize:"05"};this.threeDSVisible=!0,this.checkout.createFromAction(e.action,t).mount("#adyen-threeds-container")}},async onAdditionalDetails(e,t){try{document.body.classList.remove("gene-checkout-threeds-opened");const a=e.data?e.data:{};a.orderId=this.orderId;const s=await r(JSON.stringify(a));await this.handleAdyenResponse(s,t)}catch(e){const{message:t}=e;this.setLoadingState(!1),this.setErrorMessage(t)}},async mapAddress(e,t,a){const[s]=await d("stores.useConfigStore"),[o,...i]=e.name.split(" "),n=s.getRegionId(e.countryCode,e.administrativeArea);return{street:[e.address1,e.address2],company:e.company||"",postcode:e.postalCode,country_code:e.countryCode,email:t,firstname:o,lastname:i.length?i.join(" "):"UNKNOWN",city:e.locality,telephone:a,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...n?{region_id:n}:{}}}}}};const S={id:"adyen-threeds-container"};u.render=function(e,t,a,s,o,i){return y(),c(p,null,[h("div",{id:"adyen-google-pay",class:l(o.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-adyenGooglePay"},null,2),g(h("div",S,null,512),[[m,o.threeDSVisible]])],64)},u.__file="src/components/GooglePay/GooglePay.vue";export{u as default};
