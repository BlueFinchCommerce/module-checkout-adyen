import{m as e,g as t,a as s,u as a}from"../../AdyenStore-aSQPAtTM.min.js";import{o}from"../../index-CQ188U4T.min.js";import{c as i}from"../../clearCartAddresses-B1P6_Nur.min.js";import{g as n}from"../../getAdyenPaymentStatus-CwxFgyq2.min.js";import{l as r,c as d,b as c,n as h,w as g,F as l,o as p}from"../../loadFromCheckout-Cy42nNSj.min.js";import{v as y}from"../../runtime-dom.esm-bundler-D5EIMfl5.min.js";var m={name:"AdyenGooglePay",data:()=>({browserInfo:{},googlePayLoaded:!1,googlePayNoShippingMethods:"",key:"adyenGooglePay",orderId:null,threeDSVisible:!1}),computed:{...e(a,["isAdyenVersion"])},async created(){const[e,s,a]=await r(["stores.useCartStore","stores.useConfigStore","stores.usePaymentStore"]);a.addExpressMethod(this.key),await s.getInitialConfig(),await this.getInitialConfigValues(),await e.getCart();const i=await this.getPaymentMethodsResponse();if(!this.getGooglePayMethod(i))return this.googlePayLoaded=!0,void a.removeExpressMethod(this.key);const n=i.paymentMethods.find((e=>"paywithgoogle"===e.type||"googlepay"===e.type));if(!n)return a.removeExpressMethod(this.key),void(this.googlePayLoaded=!0);const d=await this.getGooglePayConfiguration(n),c={paymentMethodsResponse:i,locale:s.locale,environment:t()?"LIVE":"TEST",analytics:{enabled:!1}};this.checkout=await o(c);const h=this.checkout.create("googlepay",d);h.isAvailable().then((()=>{h.mount("#adyen-google-pay"),this.googlePayLoaded=!0})).catch((()=>{a.removeExpressMethod(this.key),console.warn("Google Pay is not available")})),this.browserInfo=h.browserInfo,this.googlePayNoShippingMethods=this.$t("errorMessages.googlePayNoShippingMethods")},mounted(){const e=document.createElement("script");e.setAttribute("src","https://pay.google.com/gp/p/js/pay.js"),document.head.appendChild(e)},methods:{...s(a,["getInitialConfigValues","getPaymentMethodsResponse"]),setOrderId(e){return this.orderId=e,e},async setLoadingState(e){const[t]=await r("stores.useLoadingStore");t.setLoadingState(e)},async setErrorMessage(e){const[t]=await r("stores.usePaymentStore");t.setErrorMessage(e)},getGooglePayMethod:e=>e.paymentMethods.find((({type:e})=>"paywithgoogle"===e||"googlepay")),async handeOnAuthorized(){try{document.body.classList.remove("gene-checkout-threeds-opened"),this.setLoadingState(!0);const e=await n(this.orderId);this.handleAdyenResponse(e)}catch(e){this.setLoadingState(!1);const t=e.response?.data?.message;this.setErrorMessage(t)}},async getGooglePayConfiguration(e){const[s,a]=await r(["stores.useCartStore","stores.useConfigStore"]),o=["PAYMENT_AUTHORIZATION"];return s.cart.is_virtual||o.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),{amount:{value:s.cartGrandTotal,currency:a.currencyCode},countryCode:a.countryCode,environment:t()?"LIVE":"TEST",paymentDataCallbacks:{onPaymentAuthorized:this.onPaymentAuthorized,...s.cart.is_virtual?{}:{onPaymentDataChanged:this.onPaymentDataChanged}},emailRequired:!0,shippingAddressRequired:!s.cart.is_virtual,shippingAddressParameters:{phoneNumberRequired:!s.cart.is_virtual},billingAddressRequired:!0,billingAddressParameters:{format:"FULL",phoneNumberRequired:!0},shippingOptionRequired:!s.cart.is_virtual,callbackIntents:o,configuration:{gatewayMerchantId:e.configuration.gatewayMerchantId,merchantId:e.configuration.merchantId},onAuthorized:this.handeOnAuthorized,onClick:(t,s)=>this.onClick(t,s,e.type),onSubmit:()=>{},onError:async()=>{i(),this.setLoadingState(!1)}}},async onClick(e,t,s){const[a,o,i]=await r(["helpers.expressPaymentOnClickDataLayer","stores.useAgreementStore","stores.useRecaptchaStore"]);this.setErrorMessage("");const n=o.validateAgreements(),d=i.validateToken("placeOrder");return!(!n||!d)&&(a(s),this.setLoadingState(!0),e())},onPaymentDataChanged(e){return new Promise((async t=>{const[s,a,o,i,n]=await r(["helpers.formatPrice","services.getShippingMethods","stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]);a({city:e.shippingAddress.locality,country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:i.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"}).then((async a=>{const r=a.shipping_addresses[0].available_shipping_methods,d=r.map((e=>{const t=e.carrier_title?`${s(e.price_incl_tax.value)} ${e.carrier_title}`:s(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!d.length)return void t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.googlePayNoShippingMethods,intent:"SHIPPING_ADDRESS"}});const c="shipping_option_unselected"===e.shippingOptionData.id?r[0]:r.find((({method_code:t})=>t===e.shippingOptionData.id))||r[0];await n.submitShippingInfo(c.carrier_code,c.method_code),this.setLoadingState(!0);const h={newShippingOptionParameters:{defaultSelectedOptionId:c.method_code,shippingOptions:d},newTransactionInfo:{displayItems:[{label:"Shipping",type:"LINE_ITEM",price:o.cart.shipping_addresses[0].selected_shipping_method.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:i.countryCode}};t(h)})).catch((e=>{t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:e.message,intent:"SHIPPING_ADDRESS"}})}))}))},onPaymentAuthorized(e){return new Promise((async t=>{const[s,a,o]=await r(["services.createPaymentGraphQl","services.setAddressesOnCart","stores.useCartStore"]);if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void t({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const{email:i}=e,{billingAddress:n}=e.paymentMethodData.info,{phoneNumber:d}=n,c=await this.mapAddress(n,i,d);let h=null;if(!o.cart.is_virtual){const{shippingAddress:t}=e,{phoneNumber:s}=t;h=await this.mapAddress(t,i,s)}a(h,c,i).then((()=>{const t=JSON.stringify({paymentMethod:{googlePayCardNetwork:e.paymentMethodData.info.cardNetwork,googlePayToken:e.paymentMethodData.tokenizationData.token,type:"googlepay"},browserInfo:this.browserInfo}),s=this.isAdyenVersion("9")?"adyen_additional_data":"adyen_additional_data_hpp";return{code:this.isAdyenVersion("9")?"adyen_googlepay":"adyen_hpp",[s]:{brand_code:"googlepay",stateData:t}}})).then(s).then((e=>{this.setOrderId(e),t({transactionState:"SUCCESS"})})).catch((e=>{t({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}))}))},async handleAdyenResponse(e){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,t,s]=await r(["helpers.getCartSectionNames","helpers.getSuccessPageUrl","services.refreshCustomerData"]);await s(e()),window.location.href=t()}else this.setLoadingState(!1),this.setErrorMessage(e.message)}else if(e.action){this.setErrorMessage(e.message),"threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened");const t={challengeWindowSize:"05"};this.threeDSVisible=!0,this.checkout.createFromAction(e.action,t).mount("#adyen-threeds-container")}},async mapAddress(e,t,s){const[a]=await r("stores.useConfigStore"),[o,...i]=e.name.split(" "),n=a.getRegionId(e.countryCode,e.administrativeArea);return{street:[e.address1,e.address2],company:e.company||"",postcode:e.postalCode,country_code:e.countryCode,email:t,firstname:o,lastname:i.length?i.join(" "):"UNKNOWN",city:e.locality,telephone:s,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...n?{region_id:n}:{}}}}}};const u={id:"adyen-threeds-container"};m.render=function(e,t,s,a,o,i){return p(),d(l,null,[c("div",{id:"adyen-google-pay",class:h(o.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-adyenGooglePay"},null,2),g(c("div",u,null,512),[[y,o.threeDSVisible]])],64)},m.__file="src/components/GooglePay/GooglePay.vue";export{m as default};
