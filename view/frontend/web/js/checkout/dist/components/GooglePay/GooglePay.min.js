import{m as e,g as t,a as s,u as a}from"../../AdyenStore-DOGao2-s.min.js";import{o}from"../../index-CQ188U4T.min.js";import{c as i}from"../../clearCartAddresses-B1P6_Nur.min.js";import{g as n,a as r}from"../../getAdyenPaymentDetails-CMsSkhnu.min.js";import{l as d,c,a as h,r as l,e as p,b as g,n as y,w as m,F as u,o as S}from"../../loadFromCheckout-Cy42nNSj.min.js";import{v as P}from"../../runtime-dom.esm-bundler-D5EIMfl5.min.js";var A={name:"AdyenGooglePay",data:()=>({browserInfo:{},googlePayLoaded:!1,googlePayNoShippingMethods:"",key:"adyenGooglePay",orderId:null,threeDSVisible:!1,Recaptcha:null,getTypeByPlacement:()=>{},isExpressExist:!1}),computed:{...e(a,["getAdyenClientKey","isAdyenVersion"])},async created(){const[e,s,a,i,n]=await d(["stores.useCartStore","stores.useConfigStore","stores.usePaymentStore","stores.useRecaptchaStore","components.Recaptcha"]);a.addExpressMethod(this.key),await s.getInitialConfig(),await this.getInitialConfigValues(),await e.getCart(),this.Recaptcha=n,this.getTypeByPlacement=i.getTypeByPlacement;const r=await this.getPaymentMethodsResponse(),c=this.getGooglePayMethod(r);if(this.showCaptcha(r)&&(this.isExpressExist=!0),!c)return this.googlePayLoaded=!0,void a.removeExpressMethod(this.key);const h=r.paymentMethods.find((e=>"paywithgoogle"===e.type||"googlepay"===e.type));if(!h)return a.removeExpressMethod(this.key),void(this.googlePayLoaded=!0);const l=await this.getGooglePayConfiguration(h),p={paymentMethodsResponse:r,clientKey:await this.getAdyenClientKey,locale:s.locale,environment:t()?"LIVE":"TEST",analytics:{enabled:!1},onAdditionalDetails:this.onAdditionalDetails};this.checkout=await o(p);const g=this.checkout.create("googlepay",l);g.isAvailable().then((()=>{g.mount("#adyen-google-pay"),this.googlePayLoaded=!0})).catch((()=>{a.removeExpressMethod(this.key),console.warn("Google Pay is not available")})),this.browserInfo=g.browserInfo,this.googlePayNoShippingMethods=this.$t("errorMessages.googlePayNoShippingMethods")},mounted(){const e=document.createElement("script");e.setAttribute("src","https://pay.google.com/gp/p/js/pay.js"),document.head.appendChild(e)},methods:{...s(a,["getInitialConfigValues","getPaymentMethodsResponse"]),setOrderId(e){return this.orderId=e,e},async setLoadingState(e){const[t]=await d("stores.useLoadingStore");t.setLoadingState(e)},async setErrorMessage(e){const[t]=await d("stores.usePaymentStore");t.setErrorMessage(e)},getGooglePayMethod:e=>e.paymentMethods.find((({type:e})=>"paywithgoogle"===e||"googlepay")),showCaptcha:e=>e.paymentMethods.find((({type:e})=>"paywithgoogle"===e||"googlepay")),async handeOnAuthorized(){try{document.body.classList.remove("gene-checkout-threeds-opened");const e=await n(this.orderId);this.handleAdyenResponse(e)}catch(e){this.setLoadingState(!1),i();const t=e.response?.data?.message;this.setErrorMessage(t)}},async getGooglePayConfiguration(e){const[s,a]=await d(["stores.useCartStore","stores.useConfigStore"]),o=["PAYMENT_AUTHORIZATION"];return s.cart.is_virtual||o.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),{amount:{value:s.cartGrandTotal,currency:a.currencyCode},countryCode:a.countryCode,environment:t()?"LIVE":"TEST",paymentDataCallbacks:{onPaymentAuthorized:this.onPaymentAuthorized,...s.cart.is_virtual?{}:{onPaymentDataChanged:this.onPaymentDataChanged}},emailRequired:!0,shippingAddressRequired:!s.cart.is_virtual,shippingAddressParameters:{phoneNumberRequired:!s.cart.is_virtual},billingAddressRequired:!0,billingAddressParameters:{format:"FULL",phoneNumberRequired:!0},shippingOptionRequired:!s.cart.is_virtual,callbackIntents:o,configuration:{gatewayMerchantId:e.configuration.gatewayMerchantId,merchantId:e.configuration.merchantId},onAuthorized:this.handeOnAuthorized,onClick:(t,s)=>this.onClick(t,s,e.type),onSubmit:()=>{},onError:async()=>{i(),this.setLoadingState(!1)},onCancel:async()=>{i(),this.setLoadingState(!1)}}},async onClick(e,t,s){const[a,o,i]=await d(["helpers.expressPaymentOnClickDataLayer","stores.useAgreementStore","stores.useRecaptchaStore"]);this.setErrorMessage("");const n=o.validateAgreements(),r=await i.validateToken("placeOrder","adyenExpressPayments");return!(!n||!r)&&(a(s),this.setLoadingState(!0),e())},onPaymentDataChanged(e){return new Promise((async t=>{const[s,a,o,i,n]=await d(["helpers.formatPrice","services.getShippingMethods","stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]);a({city:e.shippingAddress.locality,country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:i.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"}).then((async a=>{const r=a.shipping_addresses[0].available_shipping_methods,d=r.map((e=>{const t=e.carrier_title?`${s(e.price_incl_tax.value)} ${e.carrier_title}`:s(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!d.length)return void t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.googlePayNoShippingMethods,intent:"SHIPPING_ADDRESS"}});const c="shipping_option_unselected"===e.shippingOptionData.id?r[0]:r.find((({method_code:t})=>t===e.shippingOptionData.id))||r[0];await n.submitShippingInfo(c.carrier_code,c.method_code),this.setLoadingState(!0);const h={newShippingOptionParameters:{defaultSelectedOptionId:c.method_code,shippingOptions:d},newTransactionInfo:{displayItems:[{label:"Shipping",type:"LINE_ITEM",price:o.cart.shipping_addresses[0].selected_shipping_method.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:i.countryCode}};t(h)})).catch((e=>{t({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:e.message,intent:"SHIPPING_ADDRESS"}})}))}))},onPaymentAuthorized(e){return new Promise((async t=>{const[s,a,o]=await d(["services.createPaymentGraphQl","services.setAddressesOnCart","stores.useCartStore"]);if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void t({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const{email:i}=e,{billingAddress:n}=e.paymentMethodData.info,{phoneNumber:r}=n,c=await this.mapAddress(n,i,r);let h=null;if(!o.cart.is_virtual){const{shippingAddress:t}=e,{phoneNumber:s}=t;h=await this.mapAddress(t,i,s)}a(h,c,i).then((()=>{const t=JSON.stringify({paymentMethod:{googlePayCardNetwork:e.paymentMethodData.info.cardNetwork,googlePayToken:e.paymentMethodData.tokenizationData.token,type:"googlepay"},browserInfo:this.browserInfo}),s=this.isAdyenVersion("9")?"adyen_additional_data":"adyen_additional_data_hpp";return{code:this.isAdyenVersion("9")?"adyen_googlepay":"adyen_hpp",[s]:{brand_code:"googlepay",stateData:t}}})).then(s).then((e=>{this.setOrderId(e),t({transactionState:"SUCCESS"})})).catch((e=>{t({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}))}))},async handleAdyenResponse(e){if(e.isFinal){if(["Authorised","Received","PresentToShopper"].includes(e.resultCode)){const[e,t,s]=await d(["helpers.getCartSectionNames","helpers.getSuccessPageUrl","services.refreshCustomerData"]);await s(e()),window.location.href=t()}else i(),this.setLoadingState(!1)}else if(e.action){"threeDS2"===e.action.type&&document.body.classList.add("gene-checkout-threeds-opened");const t={challengeWindowSize:"05",onError:async e=>{this.setLoadingState(!1),document.body.classList.remove("gene-checkout-threeds-opened"),i(),this.setErrorMessage(e.message)}};this.threeDSVisible=!0,this.checkout.createFromAction(e.action,t).mount("#adyen-threeds-container")}},async onAdditionalDetails(e,t){try{document.body.classList.remove("gene-checkout-threeds-opened");const s=e.data?e.data:{};s.orderId=this.orderId;const a=await r(JSON.stringify(s));await this.handleAdyenResponse(a,t)}catch(e){const{message:t}=e;this.setLoadingState(!1),this.setErrorMessage(t)}},async mapAddress(e,t,s){const[a]=await d("stores.useConfigStore"),[o,...i]=e.name.split(" "),n=a.getRegionId(e.countryCode,e.administrativeArea);return{street:[e.address1,e.address2],company:e.company||"",postcode:e.postalCode,country_code:e.countryCode,email:t,firstname:o,lastname:i.length?i.join(" "):"UNKNOWN",city:e.locality,telephone:s,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...n?{region_id:n}:{}}}}}};const _={id:"adyen-threeds-container"};A.render=function(e,t,s,a,o,i){return S(),c(u,null,[o.getTypeByPlacement("placeOrder")&&o.isExpressExist?(S(),h(l(o.Recaptcha),{key:0,id:"placeOrder",location:"adyenExpressPayments"})):p("v-if",!0),g("div",{id:"adyen-google-pay",class:y(o.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-adyenGooglePay"},null,2),m(g("div",_,null,512),[[P,o.threeDSVisible]])],64)},A.__file="src/components/GooglePay/GooglePay.vue";export{A as default};
